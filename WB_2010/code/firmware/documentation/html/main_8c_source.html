<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Wavebubble 2010 Firmware: main.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Wavebubble 2010 Firmware</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>main.c</h1>  </div>
</div>
<div class="contents">
<a href="main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;avr/io.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;avr/pgmspace.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;avr/interrupt.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;util/delay.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;avr/eeprom.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="serial_8h.html" title="Serial header file.">serial.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="pll_8h.html" title="PLL header file.">pll.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="main_8h.html" title="Main header file.">main.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="main_8c.html#a6c61e4df3b7b68047733910211e870f1">00054</a> uint16_t EEMEM <a class="code" href="main_8c.html#a6c61e4df3b7b68047733910211e870f1" title="A dummy word is used at EEPROM address 0 to prevent corruption of data.">dummy</a> = 0; 
<a name="l00055"></a><a class="code" href="main_8c.html#a27bf4d431ba42ef782377204ba81f982">00055</a> uint16_t EEMEM <a class="code" href="main_8c.html#a27bf4d431ba42ef782377204ba81f982" title="Validity value to check for empty eeprom.">validity</a> = 0; 
<a name="l00056"></a><a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7">00056</a> uint8_t EEMEM <a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>=0; 
<a name="l00057"></a><a class="code" href="main_8c.html#a9e2a25fadc8d2b164110528880edc777">00057</a> uint8_t EEMEM <a class="code" href="main_8c.html#a9e2a25fadc8d2b164110528880edc777" title="Number of actual program in use.">curr_program</a>=0; 
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a">00059</a> uint8_t EEMEM <a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>; 
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="main_8c.html#a72d13185f58f23a129aeeb5eb70dee39">00061</a> <span class="keyword">volatile</span> uint16_t <a class="code" href="main_8c.html#a72d13185f58f23a129aeeb5eb70dee39" title="milliseconds delay counter, decremented by ISR">global_delay</a> = 0;  
<a name="l00062"></a><a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca">00062</a> <span class="keyword">volatile</span> uint16_t <a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> = 0;  
<a name="l00063"></a><a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981">00063</a> <span class="keyword">volatile</span> uint16_t <a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> = 0; 
<a name="l00064"></a><a class="code" href="main_8c.html#a90631a0a5b20aca76eb48537e2f86613">00064</a> <span class="keyword">volatile</span> uint8_t <a class="code" href="main_8c.html#a90631a0a5b20aca76eb48537e2f86613" title="1s timer for low battery threshold">lowbatt_timer</a> = 0; 
<a name="l00065"></a>00065 
<a name="l00074"></a><a class="code" href="main_8h.html#aa0dce6d249d81fb85b082273270ba710">00074</a> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#aa0dce6d249d81fb85b082273270ba710" title="Milliseconds delay function.">delay_ms</a>(uint16_t ms) {
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <a class="code" href="main_8c.html#a72d13185f58f23a129aeeb5eb70dee39" title="milliseconds delay counter, decremented by ISR">global_delay</a> = ms;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="comment">// global_delay will be decreased in timer0 ISR</span>
<a name="l00079"></a>00079   <span class="keywordflow">while</span> (<a class="code" href="main_8c.html#a72d13185f58f23a129aeeb5eb70dee39" title="milliseconds delay counter, decremented by ISR">global_delay</a> &gt; 0)
<a name="l00080"></a>00080     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> power_off(<span class="keywordtype">void</span>) {
<a name="l00088"></a>00088   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Powering OFF...\n&quot;</span>));
<a name="l00089"></a>00089   <a class="code" href="main_8c.html#aa0dce6d249d81fb85b082273270ba710" title="Milliseconds delay function.">delay_ms</a>(300);
<a name="l00090"></a>00090 <span class="preprocessor">  #ifdef HW_REV_A</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>    <span class="comment">// Power OFF device</span>
<a name="l00092"></a>00092     <a class="code" href="main_8h.html#a78f12efe2ddf06903dde4095caa77b48" title="Power ON switch port.">POWERON_PORT</a> |= _BV(<a class="code" href="main_8h.html#a5a3829e9a41139ba8c7e36b0be5a3179" title="Power ON switch pin.">POWERON</a>);
<a name="l00093"></a>00093 <span class="preprocessor">  #else</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>    <span class="comment">// Power OFF device</span>
<a name="l00095"></a>00095     <a class="code" href="main_8h.html#a78f12efe2ddf06903dde4095caa77b48" title="Power ON switch port.">POWERON_PORT</a> &amp;=~ _BV(<a class="code" href="main_8h.html#a5a3829e9a41139ba8c7e36b0be5a3179" title="Power ON switch pin.">POWERON</a>);
<a name="l00096"></a>00096 <span class="preprocessor">  #endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>}
<a name="l00098"></a>00098 
<a name="l00105"></a><a class="code" href="main_8h.html#a2c5077cc3dc7ca15aa44f09a6686fa1d">00105</a> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#a2c5077cc3dc7ca15aa44f09a6686fa1d" title="Set NE555 high frequency mode.">set_sawtooth_high</a>(<span class="keywordtype">void</span>) {
<a name="l00106"></a>00106   <span class="comment">// set the pin to be a high output</span>
<a name="l00107"></a>00107   <a class="code" href="main_8h.html#a0324da69f0137165c63687839813acbb" title="Digital frequency set direction.">FREQSET_DDR</a> |= _BV(<a class="code" href="main_8h.html#abbe73681f1dca41ed9ebd2035bc4fa2d" title="Digital frequency set pin.">FREQSET</a>);
<a name="l00108"></a>00108   <a class="code" href="main_8h.html#ab41fccd2091c5d37fa8a5396c6fe6f9c" title="Digital frequency set port.">FREQSET_PORT</a> |= _BV(<a class="code" href="main_8h.html#abbe73681f1dca41ed9ebd2035bc4fa2d" title="Digital frequency set pin.">FREQSET</a>);
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00117"></a><a class="code" href="main_8h.html#af6e3d3147f79619a3b34857aa8cfff97">00117</a> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#af6e3d3147f79619a3b34857aa8cfff97" title="Set NE555 low frequency mode.">set_sawtooth_low</a>(<span class="keywordtype">void</span>) {
<a name="l00118"></a>00118   <span class="comment">// set the pin to be a high input</span>
<a name="l00119"></a>00119   <a class="code" href="main_8h.html#a0324da69f0137165c63687839813acbb" title="Digital frequency set direction.">FREQSET_DDR</a> &amp;= ~_BV(<a class="code" href="main_8h.html#abbe73681f1dca41ed9ebd2035bc4fa2d" title="Digital frequency set pin.">FREQSET</a>);
<a name="l00120"></a>00120   <a class="code" href="main_8h.html#ab41fccd2091c5d37fa8a5396c6fe6f9c" title="Digital frequency set port.">FREQSET_PORT</a> |= _BV(<a class="code" href="main_8h.html#abbe73681f1dca41ed9ebd2035bc4fa2d" title="Digital frequency set pin.">FREQSET</a>);
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00130"></a><a class="code" href="main_8h.html#a4293a8da6724f17045a48a2e7bc85d9c">00130</a> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#a4293a8da6724f17045a48a2e7bc85d9c" title="Set digital potentiometer.">set_resistor</a>(uint8_t rnum, uint8_t rval) {
<a name="l00131"></a>00131   uint16_t d;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   d = rnum;
<a name="l00134"></a>00134   d &lt;&lt;= 8;
<a name="l00135"></a>00135   d |= rval;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   <a class="code" href="main_8h.html#af97abafa7ca4bee30b1bd78389010ebf" title="SPI CHIPSELECT Port for digital poti.">SPICS_PORT</a> &amp;= ~_BV(<a class="code" href="main_8h.html#a7c97ef3732493d3c104e15761a8ae799" title="SPI CHIPSELECT Pin for digital poti.">SPICS</a>);
<a name="l00138"></a>00138   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00139"></a>00139   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00140"></a>00140   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00141"></a>00141   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keywordflow">for</span> (rnum=0; rnum &lt; 10; rnum++) {
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (d &amp; 0x200) {
<a name="l00145"></a>00145       <a class="code" href="main_8h.html#af552321d72e6790577e0aafb22f2623b" title="SPI DATA Port for digital poti.">SPIDO_PORT</a> |= _BV(<a class="code" href="main_8h.html#ab91e2e47104a6b1490450da3add6da6f" title="SPI DATA Pin for digital poti.">SPIDO</a>);
<a name="l00146"></a>00146     } <span class="keywordflow">else</span> {
<a name="l00147"></a>00147       <a class="code" href="main_8h.html#af552321d72e6790577e0aafb22f2623b" title="SPI DATA Port for digital poti.">SPIDO_PORT</a> &amp;= ~_BV(<a class="code" href="main_8h.html#ab91e2e47104a6b1490450da3add6da6f" title="SPI DATA Pin for digital poti.">SPIDO</a>);
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <a class="code" href="main_8h.html#ab8b16de1881fad218e686843ac7adf0d" title="SPI CLOCK Port for digital poti.">SPICLK_PORT</a> |= _BV(<a class="code" href="main_8h.html#afd196d9b1d680711b2be6a32aab3bb9f" title="SPI CLOCK Pin for digital poti.">SPICLK</a>);
<a name="l00150"></a>00150     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00151"></a>00151     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00152"></a>00152     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00153"></a>00153     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00154"></a>00154     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00155"></a>00155     <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00156"></a>00156     <a class="code" href="main_8h.html#ab8b16de1881fad218e686843ac7adf0d" title="SPI CLOCK Port for digital poti.">SPICLK_PORT</a> &amp;= ~_BV(<a class="code" href="main_8h.html#afd196d9b1d680711b2be6a32aab3bb9f" title="SPI CLOCK Pin for digital poti.">SPICLK</a>);
<a name="l00157"></a>00157     d &lt;&lt;= 1;
<a name="l00158"></a>00158   }
<a name="l00159"></a>00159   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00160"></a>00160   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00161"></a>00161   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00162"></a>00162   <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00163"></a>00163   <a class="code" href="main_8h.html#af97abafa7ca4bee30b1bd78389010ebf" title="SPI CHIPSELECT Port for digital poti.">SPICS_PORT</a> |= _BV(<a class="code" href="main_8h.html#a7c97ef3732493d3c104e15761a8ae799" title="SPI CHIPSELECT Pin for digital poti.">SPICS</a>);
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00171"></a>00171 <span class="keyword">static</span> <span class="keywordtype">void</span> init_eeprom(<span class="keywordtype">void</span>) {
<a name="l00172"></a>00172   uint16_t temp;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   uint8_t *p = 0;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="comment">// Read validity word</span>
<a name="l00177"></a>00177   temp = eeprom_read_word(&amp;<a class="code" href="main_8c.html#a27bf4d431ba42ef782377204ba81f982" title="Validity value to check for empty eeprom.">validity</a>);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179   <span class="comment">// Check validity, BEEF is good here.</span>
<a name="l00180"></a>00180   <span class="keywordflow">if</span>( temp != 0xEFBE ) {
<a name="l00181"></a>00181     <span class="comment">//Not correct? Init EEPROM.</span>
<a name="l00182"></a>00182     <span class="keywordflow">for</span>(uint16_t i = 0; i &lt; E2END+1; i++) eeprom_write_byte(p++, 0);
<a name="l00183"></a>00183   }
<a name="l00184"></a>00184   eeprom_write_word(&amp;<a class="code" href="main_8c.html#a27bf4d431ba42ef782377204ba81f982" title="Validity value to check for empty eeprom.">validity</a>, 0xEFBE);
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">void</span> init_pwm(<span class="keywordtype">void</span>) {
<a name="l00192"></a>00192   DDRB |= _BV(PB1);  <span class="comment">// make OCR1A it an output</span>
<a name="l00193"></a>00193   DDRB |= _BV(PB2);  <span class="comment">// make OCR1B it an output</span>
<a name="l00194"></a>00194   TCCR1A = _BV(COM1A1) | _BV(COM1B1) | _BV(WGM12) | _BV(WGM11) | _BV(WGM10); <span class="comment">// 10bit FastPWM</span>
<a name="l00195"></a>00195   TCCR1B = _BV(CS10);
<a name="l00196"></a>00196   OCR1A = 0x0;  <span class="comment">// change this value to adjust PWM.</span>
<a name="l00197"></a>00197   OCR1B = 0x0;  <span class="comment">// change this value to adjust PWM.</span>
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00204"></a>00204 <span class="keyword">static</span> <span class="keywordtype">void</span> print_menu(<span class="keywordtype">void</span>) {
<a name="l00205"></a>00205   <a class="code" href="serial_8c.html#ad192d8264ca99bdb7076cf8aad1003dd" title="Print divider on terminal.">print_div</a>();
<a name="l00206"></a>00206   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; p &gt; Display progs\n&quot;</span>));
<a name="l00207"></a>00207   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; a &gt; Add prog\n&quot;</span>));
<a name="l00208"></a>00208   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; d &gt; Delete prog\n&quot;</span>));
<a name="l00209"></a>00209   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; t &gt; Tune prog\n&quot;</span>));
<a name="l00210"></a>00210   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; e &gt; Erase all\n&quot;</span>));
<a name="l00211"></a>00211   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; q &gt; Quit menu\n&quot;</span>));
<a name="l00212"></a>00212   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; o &gt; Power off\n&quot;</span>));
<a name="l00213"></a>00213   <a class="code" href="serial_8c.html#ad192d8264ca99bdb7076cf8aad1003dd" title="Print divider on terminal.">print_div</a>();
<a name="l00214"></a>00214   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;=&gt; &quot;</span>));
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00225"></a>00225 <span class="keyword">static</span> <span class="keywordtype">void</span> print_program(jammer_setting *setting, uint8_t n, uint8_t m) {
<a name="l00226"></a>00226   <a class="code" href="serial_8c.html#ad192d8264ca99bdb7076cf8aad1003dd" title="Print divider on terminal.">print_div</a>();
<a name="l00227"></a>00227   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Program #&quot;</span>)); <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(n+1);
<a name="l00228"></a>00228   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; of &quot;</span>));
<a name="l00229"></a>00229   <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(m); <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;High band VCO: &quot;</span>));
<a name="l00232"></a>00232   <span class="keywordflow">if</span>(setting-&gt;startfreq1 == 0) {
<a name="l00233"></a>00233     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;OFF&quot;</span>));
<a name="l00234"></a>00234   } <span class="keywordflow">else</span> {
<a name="l00235"></a>00235     <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;startfreq1);
<a name="l00236"></a>00236     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; -&gt; &quot;</span>));
<a name="l00237"></a>00237     <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;endfreq1);
<a name="l00238"></a>00238     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; (&quot;</span>)); <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;dc_offset1);
<a name="l00239"></a>00239     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;, &quot;</span>)); <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;bandwidth1);
<a name="l00240"></a>00240     <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;)&#39;</span>);
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;\nLow band VCO: &quot;</span>));
<a name="l00243"></a>00243   <span class="keywordflow">if</span>(setting-&gt;startfreq2 == 0) {
<a name="l00244"></a>00244     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;OFF&quot;</span>));
<a name="l00245"></a>00245   } <span class="keywordflow">else</span> {
<a name="l00246"></a>00246     <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;startfreq2);
<a name="l00247"></a>00247     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; -&gt; &quot;</span>));
<a name="l00248"></a>00248     <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;endfreq2);
<a name="l00249"></a>00249     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; (&quot;</span>)); <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;dc_offset2);
<a name="l00250"></a>00250     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;, &quot;</span>)); <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(setting-&gt;bandwidth2);
<a name="l00251"></a>00251     <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;)&#39;</span>);
<a name="l00252"></a>00252   }
<a name="l00253"></a>00253   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;\n&quot;</span>));
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00260"></a>00260 <span class="keyword">static</span> <span class="keywordtype">void</span> display_programs(<span class="keywordtype">void</span>) {
<a name="l00261"></a>00261   uint8_t i, progs;
<a name="l00262"></a>00262   jammer_setting setting;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264   progs = eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>);
<a name="l00265"></a>00265   <span class="keywordflow">if</span>(progs &gt; <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>) progs = <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>;
<a name="l00266"></a>00266   <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(progs);  <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; of &quot;</span>));
<a name="l00267"></a>00267   <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(<a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>);  <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot; programs in memory\n\r&quot;</span>));
<a name="l00268"></a>00268   <span class="keywordflow">for</span> (i=0; i&lt; progs; i++) {
<a name="l00269"></a>00269           eeprom_read_block(&amp;setting,
<a name="l00270"></a>00270                   &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+<span class="keyword">sizeof</span>(jammer_setting)*i,
<a name="l00271"></a>00271                   <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00272"></a>00272 
<a name="l00273"></a>00273           print_program(&amp;setting, i, progs);
<a name="l00274"></a>00274   }
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="keywordtype">void</span> delete_program(<span class="keywordtype">void</span>) {
<a name="l00282"></a>00282   uint8_t n, max;
<a name="l00283"></a>00283   jammer_setting setting;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285   display_programs();
<a name="l00286"></a>00286   <a class="code" href="serial_8c.html#ad192d8264ca99bdb7076cf8aad1003dd" title="Print divider on terminal.">print_div</a>();
<a name="l00287"></a>00287   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Delete #? &quot;</span>));
<a name="l00288"></a>00288   n = <a class="code" href="serial_8c.html#a6a99c2dde9e335bfe5c928f4e7500f3e" title="Get unisgned int from PC.">pc_read16</a>();
<a name="l00289"></a>00289   max = eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>);
<a name="l00290"></a>00290   <span class="keywordflow">if</span>(max &gt; <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>) max = <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292   <span class="keywordflow">if</span> ( (n == 0) || (n &gt; max)) {
<a name="l00293"></a>00293     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;\n\rInvalid\n\r&quot;</span>));
<a name="l00294"></a>00294     <span class="keywordflow">return</span>;
<a name="l00295"></a>00295   }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   <span class="keywordflow">if</span> (n == max) {
<a name="l00298"></a>00298     <span class="comment">// easy, just reduce program count</span>
<a name="l00299"></a>00299     eeprom_write_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>, max-1);
<a name="l00300"></a>00300   } <span class="keywordflow">else</span> {
<a name="l00301"></a>00301       <span class="comment">// Delete desired program</span>
<a name="l00302"></a>00302       <span class="keywordflow">for</span>(; n &lt; max; n++) {
<a name="l00303"></a>00303         <span class="comment">// Shift trailing program blocks</span>
<a name="l00304"></a>00304         eeprom_read_block(&amp;setting,
<a name="l00305"></a>00305                 &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+<span class="keyword">sizeof</span>(jammer_setting)*n,
<a name="l00306"></a>00306                 <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         eeprom_write_block(&amp;setting,
<a name="l00309"></a>00309                   &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+(<span class="keyword">sizeof</span>(jammer_setting)*(n-1)),
<a name="l00310"></a>00310                   <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00311"></a>00311         <span class="comment">// Remove deleted program from count</span>
<a name="l00312"></a>00312         eeprom_write_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>, max-1);
<a name="l00313"></a>00313       }
<a name="l00314"></a>00314   }
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00323"></a>00323 <span class="keyword">static</span> <span class="keywordtype">void</span> tune_it (uint8_t n, uint8_t save) {
<a name="l00324"></a>00324   jammer_setting setting;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326   eeprom_read_block(&amp;setting,
<a name="l00327"></a>00327       &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+<span class="keyword">sizeof</span>(jammer_setting)*n,
<a name="l00328"></a>00328       <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00329"></a>00329   <span class="comment">// Tune high band VCO</span>
<a name="l00330"></a>00330   <span class="keywordflow">if</span> ((setting.startfreq1 != 0) &amp;&amp; (setting.endfreq1 != 0)) {
<a name="l00331"></a>00331     setting.bandwidth1 = <a class="code" href="pll_8c.html#a705f5674d1c1dc767383471c83909bef" title="Tune specific RF band.">tune_rf_band</a>(setting.startfreq1, setting.endfreq1, 0);
<a name="l00332"></a>00332     setting.dc_offset1 = OCR1A;
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334   <span class="comment">// Tune low band VCO</span>
<a name="l00335"></a>00335   <span class="keywordflow">if</span> ((setting.startfreq2 != 0) &amp;&amp; (setting.endfreq2 != 0)) {
<a name="l00336"></a>00336     setting.bandwidth2 = <a class="code" href="pll_8c.html#a705f5674d1c1dc767383471c83909bef" title="Tune specific RF band.">tune_rf_band</a>(setting.startfreq2, setting.endfreq2, 1);
<a name="l00337"></a>00337     setting.dc_offset2 = OCR1B;
<a name="l00338"></a>00338   }
<a name="l00339"></a>00339   <span class="keywordflow">if</span> (save) {
<a name="l00340"></a>00340     eeprom_write_block(&amp;setting,
<a name="l00341"></a>00341           &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+<span class="keyword">sizeof</span>(jammer_setting)*n,
<a name="l00342"></a>00342           <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00343"></a>00343   }
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00350"></a>00350 <span class="keyword">static</span> <span class="keywordtype">void</span> tune_program(<span class="keywordtype">void</span>) {
<a name="l00351"></a>00351   uint8_t n;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="keywordflow">if</span> (eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>) == 0) {
<a name="l00354"></a>00354     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;\nNo programs stored.\n&quot;</span>));
<a name="l00355"></a>00355     <span class="keywordflow">return</span>;
<a name="l00356"></a>00356   }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   display_programs();
<a name="l00359"></a>00359   <a class="code" href="serial_8c.html#ad192d8264ca99bdb7076cf8aad1003dd" title="Print divider on terminal.">print_div</a>();
<a name="l00360"></a>00360   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Tune prog # &quot;</span>));
<a name="l00361"></a>00361   n = <a class="code" href="serial_8c.html#a6a99c2dde9e335bfe5c928f4e7500f3e" title="Get unisgned int from PC.">pc_read16</a>();
<a name="l00362"></a>00362   <span class="keywordflow">if</span> (n &gt; eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>)) {
<a name="l00363"></a>00363     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;\n\rInvalid #\n&quot;</span>));
<a name="l00364"></a>00364   } <span class="keywordflow">else</span> {
<a name="l00365"></a>00365     tune_it(n-1, 1);
<a name="l00366"></a>00366   }
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00373"></a>00373 <span class="keyword">static</span> <span class="keywordtype">void</span> add_program(<span class="keywordtype">void</span>) {
<a name="l00374"></a>00374   jammer_setting new_setting;
<a name="l00375"></a>00375   uint8_t progs;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377   progs = eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>);
<a name="l00378"></a>00378   <span class="keywordflow">if</span>(progs &gt;= <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>) {
<a name="l00379"></a>00379     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Memory full.\n&quot;</span>));
<a name="l00380"></a>00380     <span class="keywordflow">return</span>;
<a name="l00381"></a>00381   }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Enter start and stop frequency for each VCO.\nEnter 0 to turn OFF VCO.\n&quot;</span>));
<a name="l00384"></a>00384   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Low Band: 345-1350MHz - High Band 1225-2715MHz\n\n&quot;</span>));
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 highbandstart:
<a name="l00387"></a>00387   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;High band VCO\nstart: &quot;</span>));
<a name="l00388"></a>00388   new_setting.startfreq1 = <a class="code" href="serial_8c.html#a6a99c2dde9e335bfe5c928f4e7500f3e" title="Get unisgned int from PC.">pc_read16</a>();
<a name="l00389"></a>00389   <span class="keywordflow">if</span>(new_setting.startfreq1 == 0) {
<a name="l00390"></a>00390     new_setting.endfreq1 = 0;
<a name="l00391"></a>00391     <span class="keywordflow">goto</span> lowbandstart;
<a name="l00392"></a>00392   }
<a name="l00393"></a>00393   <span class="keywordflow">if</span>(new_setting.startfreq1 &lt; <a class="code" href="main_8h.html#ac2f357e196c405d5dea2dbd9733cec5b">HIGHBAND_VCO_LOW</a>) {
<a name="l00394"></a>00394     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Frequency to low.\n&quot;</span>));
<a name="l00395"></a>00395     <span class="keywordflow">goto</span> highbandstart;
<a name="l00396"></a>00396   }
<a name="l00397"></a>00397 highbandend:
<a name="l00398"></a>00398   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;end: &quot;</span>));
<a name="l00399"></a>00399   new_setting.endfreq1 = <a class="code" href="serial_8c.html#a6a99c2dde9e335bfe5c928f4e7500f3e" title="Get unisgned int from PC.">pc_read16</a>();
<a name="l00400"></a>00400   <span class="keywordflow">if</span>(new_setting.endfreq1 &gt; <a class="code" href="main_8h.html#afb0ae7603d867e06c42771aa59facebf">HIGHBAND_VCO_HIGH</a>) {
<a name="l00401"></a>00401     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Frequency to high.\n&quot;</span>));
<a name="l00402"></a>00402     <span class="keywordflow">goto</span> highbandend;
<a name="l00403"></a>00403   }
<a name="l00404"></a>00404 lowbandstart:
<a name="l00405"></a>00405   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;\nLow band VCO\nstart: &quot;</span>));
<a name="l00406"></a>00406   new_setting.startfreq2 = <a class="code" href="serial_8c.html#a6a99c2dde9e335bfe5c928f4e7500f3e" title="Get unisgned int from PC.">pc_read16</a>();
<a name="l00407"></a>00407   <span class="keywordflow">if</span>(new_setting.startfreq2 == 0) {
<a name="l00408"></a>00408     new_setting.endfreq2 = 0;
<a name="l00409"></a>00409     <span class="keywordflow">goto</span> saveprog;
<a name="l00410"></a>00410   }
<a name="l00411"></a>00411   <span class="keywordflow">if</span>(new_setting.startfreq2 &lt; <a class="code" href="main_8h.html#a3b1a9803fa06e83da18bc1726dd9df6a">LOWBAND_VCO_LOW</a>) {
<a name="l00412"></a>00412     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Frequency to low.\n&quot;</span>));
<a name="l00413"></a>00413     <span class="keywordflow">goto</span> lowbandstart;
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415 lowbandend:
<a name="l00416"></a>00416   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;end: &quot;</span>));
<a name="l00417"></a>00417   new_setting.endfreq2 = <a class="code" href="serial_8c.html#a6a99c2dde9e335bfe5c928f4e7500f3e" title="Get unisgned int from PC.">pc_read16</a>();
<a name="l00418"></a>00418   <span class="keywordflow">if</span>(new_setting.endfreq2 &gt; <a class="code" href="main_8h.html#a5c8b7a3c69ecf2f92187e12e070110fd">LOWBAND_VCO_HIGH</a>) {
<a name="l00419"></a>00419     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Frequency to high.\n&quot;</span>));
<a name="l00420"></a>00420     <span class="keywordflow">goto</span> lowbandend;
<a name="l00421"></a>00421   }
<a name="l00422"></a>00422 saveprog:
<a name="l00423"></a>00423   <span class="keywordflow">if</span>( (new_setting.startfreq1 == 0) &amp;&amp; (new_setting.startfreq2 == 0)) {
<a name="l00424"></a>00424     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Nothing to save.\n&quot;</span>));
<a name="l00425"></a>00425     <span class="keywordflow">return</span>;
<a name="l00426"></a>00426   }
<a name="l00427"></a>00427   new_setting.dc_offset1 = new_setting.dc_offset2 = 0;
<a name="l00428"></a>00428   new_setting.bandwidth1 = new_setting.bandwidth2 = 0;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   eeprom_write_block(&amp;new_setting,
<a name="l00431"></a>00431             &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+(<span class="keyword">sizeof</span>(jammer_setting)*progs),
<a name="l00432"></a>00432             <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00433"></a>00433 
<a name="l00434"></a>00434   eeprom_write_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>, progs+1);
<a name="l00435"></a>00435   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Saved program &quot;</span>)); <a class="code" href="serial_8c.html#a4e518e6b58785897289ed35b65d1890d" title="Send unsigned int number in ASCII to PC.">putnum_ud</a>(progs+1);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437   <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00444"></a>00444 <span class="keyword">static</span> <span class="keywordtype">void</span> run_menu(<span class="keywordtype">void</span>) {
<a name="l00445"></a>00445   <span class="keywordtype">char</span> c;
<a name="l00446"></a>00446   <span class="keywordflow">do</span> {
<a name="l00447"></a>00447     print_menu();
<a name="l00448"></a>00448     c = <a class="code" href="serial_8c.html#a7fd493070691b82ec8eea17a51bb2661" title="Get one byte from PC.">pc_getc</a>();
<a name="l00449"></a>00449     <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(c);
<a name="l00450"></a>00450     <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00451"></a>00451     <span class="keywordflow">switch</span> (c) {
<a name="l00452"></a>00452       <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:
<a name="l00453"></a>00453         display_programs();
<a name="l00454"></a>00454         <span class="keywordflow">break</span>;
<a name="l00455"></a>00455       <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:
<a name="l00456"></a>00456         add_program();
<a name="l00457"></a>00457         <span class="keywordflow">break</span>;
<a name="l00458"></a>00458       <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:
<a name="l00459"></a>00459         delete_program();
<a name="l00460"></a>00460         <span class="keywordflow">break</span>;
<a name="l00461"></a>00461       <span class="keywordflow">case</span> <span class="charliteral">&#39;t&#39;</span>:
<a name="l00462"></a>00462         tune_program();
<a name="l00463"></a>00463         <span class="keywordflow">break</span>;
<a name="l00464"></a>00464       <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:
<a name="l00465"></a>00465         <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Erase all programs? y/n: &quot;</span>));
<a name="l00466"></a>00466         c = <a class="code" href="serial_8c.html#a7fd493070691b82ec8eea17a51bb2661" title="Get one byte from PC.">pc_getc</a>();
<a name="l00467"></a>00467         <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(c);
<a name="l00468"></a>00468         <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00469"></a>00469         <span class="keywordflow">if</span>(c == <span class="charliteral">&#39;y&#39;</span>) {
<a name="l00470"></a>00470           eeprom_write_word(&amp;<a class="code" href="main_8c.html#a27bf4d431ba42ef782377204ba81f982" title="Validity value to check for empty eeprom.">validity</a>, 0x0000);
<a name="l00471"></a>00471           init_eeprom();
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473         <span class="keywordflow">break</span>;
<a name="l00474"></a>00474       <span class="keywordflow">case</span> <span class="charliteral">&#39;q&#39;</span>: <span class="keywordflow">break</span>;
<a name="l00475"></a>00475       <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:
<a name="l00476"></a>00476         power_off();
<a name="l00477"></a>00477         <span class="keywordflow">break</span>;
<a name="l00478"></a>00478       <span class="keywordflow">default</span>:
<a name="l00479"></a>00479         <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Bad command\n&quot;</span>));
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481   } <span class="keywordflow">while</span> (c != <span class="charliteral">&#39;q&#39;</span>);
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 
<a name="l00491"></a><a class="code" href="main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">00491</a> <span class="keywordtype">int</span> <a class="code" href="main_8c.html#a840291bc02cba5474a4cb46a9b9566fe" title="The main function.">main</a>(<span class="keywordtype">void</span>) {
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   OSCCAL = 0xC0; <span class="comment">// Calibrate internal RC oscillator</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495   <span class="comment">// setup system tick counter</span>
<a name="l00496"></a>00496   OCR0A = 125; <span class="comment">// timer0 capture at 1ms</span>
<a name="l00497"></a>00497   TCCR0A |= _BV(WGM01);
<a name="l00498"></a>00498   TCCR0B |=  _BV(CS01) | _BV(CS00); <span class="comment">// Set timer0 CTC mode, prescaler 64</span>
<a name="l00499"></a>00499   TIMSK0 |= _BV (OCIE0A); <span class="comment">// Enable timer0 output compare interrupt</span>
<a name="l00500"></a>00500 
<a name="l00501"></a>00501   sei(); <span class="comment">// Enable global interrupts</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   <a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> = 0;
<a name="l00504"></a>00504   <span class="comment">// Power key must be pressed at least 2 seconds to power ON</span>
<a name="l00505"></a>00505   <span class="keywordflow">while</span>(<a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> &lt; 2000) <span class="keyword">asm</span> <span class="keyword">volatile</span> (<span class="stringliteral">&quot;nop&quot;</span>);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   <span class="comment">// Power ON switch pin output and force HIGH to keep device running</span>
<a name="l00508"></a>00508   <a class="code" href="main_8h.html#a78f12efe2ddf06903dde4095caa77b48" title="Power ON switch port.">POWERON_PORT</a> |= _BV(<a class="code" href="main_8h.html#a5a3829e9a41139ba8c7e36b0be5a3179" title="Power ON switch pin.">POWERON</a>);
<a name="l00509"></a>00509   <a class="code" href="main_8h.html#a38efe47b0e8e6fe0c2f620fd26e36a38" title="Power ON direction.">POWERON_DDR</a> |= _BV(<a class="code" href="main_8h.html#a5a3829e9a41139ba8c7e36b0be5a3179" title="Power ON switch pin.">POWERON</a>);
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   <a class="code" href="serial_8c.html#a6aa3b4e2a5362cd032ed6b218afe58f6" title="Init USART.">usart_init</a>(); <span class="comment">// Init serial communication</span>
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   DDRD |= _BV(PD1);     <span class="comment">// USART TxD0 output</span>
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   <span class="comment">// LED pin output and LED on</span>
<a name="l00516"></a>00516   <a class="code" href="main_8h.html#a4e61b89de08b0b5ee01b8d31e4be4a83" title="Direction for LED.">LEDDDR</a> |= _BV(<a class="code" href="main_8h.html#aeb7a7ba1ab7e0406f1b5ab36d579f585" title="Pin for LED.">LED</a>);
<a name="l00517"></a>00517   <a class="code" href="main_8h.html#afc9565c547105e5535bd356fa93ae10b" title="Port for LED.">LEDPORT</a> |= _BV(<a class="code" href="main_8h.html#aeb7a7ba1ab7e0406f1b5ab36d579f585" title="Pin for LED.">LED</a>);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   <span class="comment">// Program key input and pull-up</span>
<a name="l00520"></a>00520   <a class="code" href="main_8h.html#a4b8a45a727981f60d231b1bbe710ecd1" title="Program key port.">PROGKEY_PORT</a> |= _BV(<a class="code" href="main_8h.html#a03fee2de857496c67060029e28000e58" title="Program key pin.">PROGKEY</a>);
<a name="l00521"></a>00521   <a class="code" href="main_8h.html#a7b7b9c1e18f888fd1553d88d7c5d317d" title="Program key direction.">PROGKEY_DDR</a> &amp;=~ _BV(<a class="code" href="main_8h.html#a03fee2de857496c67060029e28000e58" title="Program key pin.">PROGKEY</a>);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   <span class="comment">// Setup port and pins for software SPI operation to control digital potentiometer</span>
<a name="l00524"></a>00524   <a class="code" href="main_8h.html#af2ed84802b91b65a60f735bc4c264874" title="SPI CHIPSELECT Direction for digital poti.">SPICS_DDR</a> |= _BV(<a class="code" href="main_8h.html#a7c97ef3732493d3c104e15761a8ae799" title="SPI CHIPSELECT Pin for digital poti.">SPICS</a>);
<a name="l00525"></a>00525   <a class="code" href="main_8h.html#a22ddacad7cb9892856bebfadeb36dd80" title="SPI DATA Direction for digital poti.">SPIDO_DDR</a> |= _BV(<a class="code" href="main_8h.html#ab91e2e47104a6b1490450da3add6da6f" title="SPI DATA Pin for digital poti.">SPIDO</a>);
<a name="l00526"></a>00526   <a class="code" href="main_8h.html#adf182868be8b3b746429e4a31ddf1b3d" title="SPI CLOCK Direction for digital poti.">SPICLK_DDR</a> |= _BV(<a class="code" href="main_8h.html#afd196d9b1d680711b2be6a32aab3bb9f" title="SPI CLOCK Pin for digital poti.">SPICLK</a>);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <a class="code" href="main_8h.html#af97abafa7ca4bee30b1bd78389010ebf" title="SPI CHIPSELECT Port for digital poti.">SPICS_PORT</a> |= _BV(<a class="code" href="main_8h.html#a7c97ef3732493d3c104e15761a8ae799" title="SPI CHIPSELECT Pin for digital poti.">SPICS</a>);
<a name="l00529"></a>00529   <a class="code" href="main_8h.html#ab8b16de1881fad218e686843ac7adf0d" title="SPI CLOCK Port for digital poti.">SPICLK_PORT</a> &amp;= ~_BV(<a class="code" href="main_8h.html#afd196d9b1d680711b2be6a32aab3bb9f" title="SPI CLOCK Pin for digital poti.">SPICLK</a>);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531   <span class="comment">// Setup VCO power control port and pins</span>
<a name="l00532"></a>00532   <a class="code" href="main_8h.html#a6813e2fde3db97b8baf5e6bca29fe4f8" title="Power control direction VCO1.">POWERCTL1_DDR</a> |= _BV(<a class="code" href="main_8h.html#a183dd65e8265e19e932bbadfb144cb79" title="Power control pin VCO1.">POWERCTL1</a>);
<a name="l00533"></a>00533   <a class="code" href="main_8h.html#aabacb9e1ca9edb2a6e2a53520a946383" title="Power control direction VCO2.">POWERCTL2_DDR</a> |= _BV(<a class="code" href="main_8h.html#ab6e1f2f6adae9fab1becfc152e2d8038" title="Power control pin VCO2.">POWERCTL2</a>);
<a name="l00534"></a>00534   <a class="code" href="main_8h.html#a3f159d2049a4f29ad1facd5b00a6756e" title="Power control port VCO1.">POWERCTL1_PORT</a> &amp;= ~_BV(<a class="code" href="main_8h.html#a183dd65e8265e19e932bbadfb144cb79" title="Power control pin VCO1.">POWERCTL1</a>); <span class="comment">// turn off VCO1+gain stage</span>
<a name="l00535"></a>00535   <a class="code" href="main_8h.html#a11ea80dab05e720a4079e0f3baaa1bd4" title="Power control port VCO2.">POWERCTL2_PORT</a> &amp;= ~_BV(<a class="code" href="main_8h.html#ab6e1f2f6adae9fab1becfc152e2d8038" title="Power control pin VCO2.">POWERCTL2</a>); <span class="comment">// turn off VCO2+gain stage</span>
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   init_pwm(); <span class="comment">// Init tuning voltage generator</span>
<a name="l00538"></a>00538 
<a name="l00539"></a>00539   <a class="code" href="pll_8c.html#ad9e7fcfc46402ee91ee2d711c1135815" title="Init PLL.">pll_init</a>(); <span class="comment">// Init PLL control</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541   <span class="comment">// Set digital potentiometer to minimum</span>
<a name="l00542"></a>00542   <a class="code" href="main_8c.html#a4293a8da6724f17045a48a2e7bc85d9c" title="Set digital potentiometer.">set_resistor</a>(<a class="code" href="main_8h.html#a7d9b2217db668311f000ce9ee32ecf06" title="Digital potentiometer for VCO1.">BANDWADJ1_RES</a>, 0);
<a name="l00543"></a>00543   <a class="code" href="main_8c.html#a4293a8da6724f17045a48a2e7bc85d9c" title="Set digital potentiometer.">set_resistor</a>(<a class="code" href="main_8h.html#aa1a64792c41ac3ecf46b7092c072b47a" title="Digital potentiometer for VCO2.">BANDWADJ2_RES</a>, 0);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545   <a class="code" href="main_8c.html#af6e3d3147f79619a3b34857aa8cfff97" title="Set NE555 low frequency mode.">set_sawtooth_low</a>(); <span class="comment">// Set NE555 mode</span>
<a name="l00546"></a>00546 
<a name="l00547"></a>00547   init_eeprom();  <span class="comment">// Check EEPROM validity</span>
<a name="l00548"></a>00548 
<a name="l00549"></a>00549   <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Wave Bubble 2010\nFW: &quot;</span> __DATE__<span class="stringliteral">&quot; / &quot;</span> __TIME__<span class="stringliteral">&quot;\n\n&quot;</span>));
<a name="l00550"></a>00550 
<a name="l00551"></a>00551   uint8_t progs, programnum;
<a name="l00552"></a>00552   jammer_setting setting;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554   progs = eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>);
<a name="l00555"></a>00555   <span class="keywordflow">if</span>(progs &gt; <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>) progs = <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557   <span class="keywordflow">if</span>  (progs != 0) {
<a name="l00558"></a>00558     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;Press key to enter menu...&quot;</span>));
<a name="l00559"></a>00559     <a class="code" href="main_8c.html#aa0dce6d249d81fb85b082273270ba710" title="Milliseconds delay function.">delay_ms</a>(2000);
<a name="l00560"></a>00560   }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 no_progs:       <span class="comment">// Go here in case &#39;q&#39; is pressed and no programs are stored</span>
<a name="l00563"></a>00563 
<a name="l00564"></a>00564   <span class="keywordflow">if</span> ( (UCSR0A &amp; _BV(RXC0)) &amp;&amp; isascii(<a class="code" href="serial_8c.html#a7fd493070691b82ec8eea17a51bb2661" title="Get one byte from PC.">pc_getc</a>()) ) {
<a name="l00565"></a>00565     <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00566"></a>00566     run_menu();
<a name="l00567"></a>00567   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (progs == 0)
<a name="l00568"></a>00568     run_menu();
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 run_prog:       <span class="comment">// Go here when program key is pressed, switch to next program</span>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572   progs = eeprom_read_byte(&amp;<a class="code" href="main_8c.html#ae85b25b4d379c65c5317b14b557ea9f7" title="Number of programs in eeprom.">max_programs</a>);
<a name="l00573"></a>00573   <span class="keywordflow">if</span>(progs == 0) {
<a name="l00574"></a>00574     <a class="code" href="serial_8c.html#a5357df389b4d683f197a9b9ea40d2023" title="Send flash string to PC.">pc_puts_P</a>(PSTR(<span class="stringliteral">&quot;No programs stored.\n&quot;</span>));
<a name="l00575"></a>00575     <span class="keywordflow">goto</span> no_progs;
<a name="l00576"></a>00576   }
<a name="l00577"></a>00577   <span class="keywordflow">if</span>(progs &gt; <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>) progs = <a class="code" href="main_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169">MAX_PROGRAMS</a>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579   programnum = eeprom_read_byte(&amp;<a class="code" href="main_8c.html#a9e2a25fadc8d2b164110528880edc777" title="Number of actual program in use.">curr_program</a>);
<a name="l00580"></a>00580   <span class="keywordflow">if</span> (programnum &gt;= progs)
<a name="l00581"></a>00581     programnum = 0;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   eeprom_read_block(&amp;setting,
<a name="l00584"></a>00584             &amp;<a class="code" href="main_8c.html#a6c023c94e45b228c900199cc03028f6a" title="Offset where we start to save out setting.">settings_ee</a>+<span class="keyword">sizeof</span>(jammer_setting)*programnum,
<a name="l00585"></a>00585             <span class="keyword">sizeof</span>(jammer_setting));
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <a class="code" href="serial_8c.html#a67632feeb7a91340aa4536ee92895bd5" title="Send one byte to PC.">pc_putc</a>(<span class="charliteral">&#39;\n&#39;</span>);
<a name="l00588"></a>00588   print_program(&amp;setting, programnum, progs);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590   <a class="code" href="serial_8c.html#ad192d8264ca99bdb7076cf8aad1003dd" title="Print divider on terminal.">print_div</a>();
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <span class="keywordflow">if</span> ((setting.dc_offset1 == 0) &amp;&amp; (setting.bandwidth1 == 0) &amp;&amp;
<a name="l00593"></a>00593     (setting.dc_offset2 == 0) &amp;&amp; (setting.bandwidth2 == 0)) {
<a name="l00594"></a>00594             tune_it(programnum, 0); <span class="comment">// mem check return</span>
<a name="l00595"></a>00595   } <span class="keywordflow">else</span> {
<a name="l00596"></a>00596     <span class="keywordflow">if</span> (setting.startfreq1 != 0) {
<a name="l00597"></a>00597             OCR1A = setting.dc_offset1;
<a name="l00598"></a>00598             <a class="code" href="main_8c.html#a4293a8da6724f17045a48a2e7bc85d9c" title="Set digital potentiometer.">set_resistor</a>(<a class="code" href="main_8h.html#a7d9b2217db668311f000ce9ee32ecf06" title="Digital potentiometer for VCO1.">BANDWADJ1_RES</a>, setting.bandwidth1);
<a name="l00599"></a>00599             <a class="code" href="main_8h.html#a3f159d2049a4f29ad1facd5b00a6756e" title="Power control port VCO1.">POWERCTL1_PORT</a> |= _BV(<a class="code" href="main_8h.html#a183dd65e8265e19e932bbadfb144cb79" title="Power control pin VCO1.">POWERCTL1</a>); <span class="comment">// turn on vcos/gain</span>
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601     <span class="keywordflow">if</span> (setting.startfreq2 != 0) {
<a name="l00602"></a>00602             OCR1B = setting.dc_offset2;
<a name="l00603"></a>00603             <a class="code" href="main_8c.html#a4293a8da6724f17045a48a2e7bc85d9c" title="Set digital potentiometer.">set_resistor</a>(<a class="code" href="main_8h.html#aa1a64792c41ac3ecf46b7092c072b47a" title="Digital potentiometer for VCO2.">BANDWADJ2_RES</a>, setting.bandwidth2);
<a name="l00604"></a>00604             <a class="code" href="main_8h.html#a11ea80dab05e720a4079e0f3baaa1bd4" title="Power control port VCO2.">POWERCTL2_PORT</a> |= _BV(<a class="code" href="main_8h.html#ab6e1f2f6adae9fab1becfc152e2d8038" title="Power control pin VCO2.">POWERCTL2</a>); <span class="comment">// turn on vcos/gain</span>
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606   }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608   uint8_t key_press = 0, led_count = 0;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610   <span class="keywordflow">for</span>(;;) {
<a name="l00611"></a>00611     <span class="comment">// check battery voltage</span>
<a name="l00612"></a>00612     uint16_t batt = 0;
<a name="l00613"></a>00613     ADMUX = 6;
<a name="l00614"></a>00614     ADCSRA |=  _BV(ADSC);
<a name="l00615"></a>00615     <span class="keywordflow">while</span> (ADCSRA &amp; _BV(ADSC)); <span class="comment">// wait for conversion to finish</span>
<a name="l00616"></a>00616     batt = ADC;
<a name="l00617"></a>00617     <span class="comment">//putnum_ud(batt); pc_putc(&#39;\n&#39;);</span>
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="comment">// Reset low battery timer as long as battery voltage is good</span>
<a name="l00620"></a>00620     <span class="keywordflow">if</span>(batt &gt; 310) <a class="code" href="main_8c.html#a90631a0a5b20aca76eb48537e2f86613" title="1s timer for low battery threshold">lowbatt_timer</a> = 100; <span class="comment">// 100 x 10ms time for low batt before power off</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <span class="keywordflow">if</span>(<a class="code" href="main_8c.html#a90631a0a5b20aca76eb48537e2f86613" title="1s timer for low battery threshold">lowbatt_timer</a> == 0)
<a name="l00623"></a>00623     {
<a name="l00624"></a>00624 <span class="preprocessor">      #ifdef HW_REV_A</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>        <span class="comment">// Power OFF device</span>
<a name="l00626"></a>00626         <a class="code" href="main_8h.html#a78f12efe2ddf06903dde4095caa77b48" title="Power ON switch port.">POWERON_PORT</a> |= _BV(<a class="code" href="main_8h.html#a5a3829e9a41139ba8c7e36b0be5a3179" title="Power ON switch pin.">POWERON</a>);
<a name="l00627"></a>00627 <span class="preprocessor">      #else</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>        <span class="comment">// Power OFF device</span>
<a name="l00629"></a>00629         <a class="code" href="main_8h.html#a78f12efe2ddf06903dde4095caa77b48" title="Power ON switch port.">POWERON_PORT</a> &amp;=~ _BV(<a class="code" href="main_8h.html#a5a3829e9a41139ba8c7e36b0be5a3179" title="Power ON switch pin.">POWERON</a>);
<a name="l00630"></a>00630 <span class="preprocessor">      #endif</span>
<a name="l00631"></a>00631 <span class="preprocessor"></span>      <span class="keywordflow">while</span>(1);
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="comment">// check if a key was pressed earlier</span>
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (key_press) {
<a name="l00636"></a>00636       <span class="comment">// check if key has been realesed</span>
<a name="l00637"></a>00637       <span class="keywordflow">if</span> (bit_is_set (<a class="code" href="main_8h.html#a2bcc8ce50f77f554eed883e51ccacbee" title="Program key input.">PROGKEY_PIN</a>, <a class="code" href="main_8h.html#a03fee2de857496c67060029e28000e58" title="Program key pin.">PROGKEY</a>)) {
<a name="l00638"></a>00638         <span class="comment">// key is released</span>
<a name="l00639"></a>00639         <span class="keywordflow">if</span> ((<a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> &gt; 0) &amp;&amp; (<a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> &lt; 800)) {       <span class="comment">// max 0.8 sec for shortpress</span>
<a name="l00640"></a>00640           <a class="code" href="main_8h.html#afc9565c547105e5535bd356fa93ae10b" title="Port for LED.">LEDPORT</a> &amp;=~ _BV(<a class="code" href="main_8h.html#aeb7a7ba1ab7e0406f1b5ab36d579f585" title="Pin for LED.">LED</a>); <span class="comment">// turn LED off in any case</span>
<a name="l00641"></a>00641           <a class="code" href="main_8h.html#a3f159d2049a4f29ad1facd5b00a6756e" title="Power control port VCO1.">POWERCTL1_PORT</a> &amp;=~ _BV(<a class="code" href="main_8h.html#a183dd65e8265e19e932bbadfb144cb79" title="Power control pin VCO1.">POWERCTL1</a>); <span class="comment">// turn VCOs off</span>
<a name="l00642"></a>00642           <a class="code" href="main_8h.html#a11ea80dab05e720a4079e0f3baaa1bd4" title="Power control port VCO2.">POWERCTL2_PORT</a> &amp;=~ _BV(<a class="code" href="main_8h.html#ab6e1f2f6adae9fab1becfc152e2d8038" title="Power control pin VCO2.">POWERCTL2</a>); <span class="comment">// will be turned on dependent on next program</span>
<a name="l00643"></a>00643           eeprom_write_byte(&amp;<a class="code" href="main_8c.html#a9e2a25fadc8d2b164110528880edc777" title="Number of actual program in use.">curr_program</a>, programnum+1);
<a name="l00644"></a>00644           <span class="keywordflow">goto</span> run_prog;
<a name="l00645"></a>00645         }
<a name="l00646"></a>00646         key_press = 0;
<a name="l00647"></a>00647       }
<a name="l00648"></a>00648       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> &gt; 800) &amp;&amp; (<a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> &lt; 5000)) { <span class="comment">// long keypress ?</span>
<a name="l00649"></a>00649         power_off();
<a name="l00650"></a>00650       }
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652     <span class="keywordflow">else</span> {
<a name="l00653"></a>00653       <span class="comment">// check if key is pressed</span>
<a name="l00654"></a>00654       <span class="keywordflow">if</span> (bit_is_clear (<a class="code" href="main_8h.html#a2bcc8ce50f77f554eed883e51ccacbee" title="Program key input.">PROGKEY_PIN</a>, <a class="code" href="main_8h.html#a03fee2de857496c67060029e28000e58" title="Program key pin.">PROGKEY</a>)) {
<a name="l00655"></a>00655           <a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a> = 0; <span class="comment">// reset key press timer</span>
<a name="l00656"></a>00656           key_press = 1;
<a name="l00657"></a>00657       }
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="comment">/* Indicate selected program with blinking LED</span>
<a name="l00661"></a>00661 <span class="comment">     *</span>
<a name="l00662"></a>00662 <span class="comment">     * LED will blink program number of times followed by 1s pause</span>
<a name="l00663"></a>00663 <span class="comment">     */</span>
<a name="l00664"></a>00664     <span class="keywordflow">if</span>( <a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> == 0) {
<a name="l00665"></a>00665       <span class="keywordflow">if</span>( led_count == 0) {
<a name="l00666"></a>00666         led_count = programnum+1;
<a name="l00667"></a>00667         <a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> = 1000;
<a name="l00668"></a>00668       }
<a name="l00669"></a>00669       <span class="keywordflow">else</span> {
<a name="l00670"></a>00670         <span class="keywordflow">if</span>(bit_is_clear(<a class="code" href="main_8h.html#afc9565c547105e5535bd356fa93ae10b" title="Port for LED.">LEDPORT</a>,<a class="code" href="main_8h.html#aeb7a7ba1ab7e0406f1b5ab36d579f585" title="Pin for LED.">LED</a>)) {
<a name="l00671"></a>00671           <a class="code" href="main_8h.html#afc9565c547105e5535bd356fa93ae10b" title="Port for LED.">LEDPORT</a> |= _BV(<a class="code" href="main_8h.html#aeb7a7ba1ab7e0406f1b5ab36d579f585" title="Pin for LED.">LED</a>);
<a name="l00672"></a>00672           <span class="keywordflow">if</span>(led_count == 0) {
<a name="l00673"></a>00673             <a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> = 1000;
<a name="l00674"></a>00674           }
<a name="l00675"></a>00675           <span class="keywordflow">else</span> {
<a name="l00676"></a>00676             <a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> = 100;
<a name="l00677"></a>00677           }
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679         <span class="keywordflow">else</span> {
<a name="l00680"></a>00680           <a class="code" href="main_8h.html#afc9565c547105e5535bd356fa93ae10b" title="Port for LED.">LEDPORT</a> &amp;=~ _BV(<a class="code" href="main_8h.html#aeb7a7ba1ab7e0406f1b5ab36d579f585" title="Pin for LED.">LED</a>);
<a name="l00681"></a>00681           <a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> = 300;
<a name="l00682"></a>00682           --led_count;
<a name="l00683"></a>00683         }
<a name="l00684"></a>00684       }
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687   } <span class="comment">// end for(;;)</span>
<a name="l00688"></a>00688 
<a name="l00689"></a>00689   <span class="keywordflow">return</span> 0;
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 
<a name="l00699"></a><a class="code" href="main_8c.html#aec43762dc86e029b395d4e5819192c2d">00699</a> <a class="code" href="main_8c.html#aec43762dc86e029b395d4e5819192c2d" title="Timer0 OCR interrupt service routine.">ISR</a>(TIMER0_COMPA_vect)
<a name="l00700"></a>00700 {
<a name="l00701"></a>00701   <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a72d13185f58f23a129aeeb5eb70dee39" title="milliseconds delay counter, decremented by ISR">global_delay</a> &gt; 0) --<a class="code" href="main_8c.html#a72d13185f58f23a129aeeb5eb70dee39" title="milliseconds delay counter, decremented by ISR">global_delay</a>;
<a name="l00702"></a>00702   <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a> &gt; 0) --<a class="code" href="main_8c.html#a4b5fcbc5bb560b71592ef7a8166f10ca" title="LED blink timer.">led_delay</a>;
<a name="l00703"></a>00703   <span class="keywordflow">if</span> (<a class="code" href="main_8c.html#a90631a0a5b20aca76eb48537e2f86613" title="1s timer for low battery threshold">lowbatt_timer</a> &gt; 0) --<a class="code" href="main_8c.html#a90631a0a5b20aca76eb48537e2f86613" title="1s timer for low battery threshold">lowbatt_timer</a>;
<a name="l00704"></a>00704   <a class="code" href="main_8c.html#ac617b4abac09a6ce1e064437b00da981" title="Key press timer to debounce and detect short/long press.">key_delay</a>++;
<a name="l00705"></a>00705 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sat Aug 20 2011 21:40:07 for Wavebubble 2010 Firmware by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
